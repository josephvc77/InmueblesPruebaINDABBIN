{% extends 'base.html' %}

{% block titulo %}Tareas Pendientes{% endblock %}

{% block content %}
<style>
  .contenedor-inmuebles {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 100vw;
  }

  .search-form {
    max-width: 1000px;
    margin: 0 auto 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    background: #fafafa;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
  }

  .search-form > * {
    flex-grow: 1;
    min-width: 180px;
  }

  .search-form label {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 6px;
    display: block;
    color: #333;
  }

  .search-form input[type="text"],
  .search-form select {
    width: 100%;
    padding: 8px 10px;
    font-size: 1rem;
    border: 1px solid #bbb;
    border-radius: 4px;
    transition: border-color 0.3s ease;
  }

  .search-form input[type="text"]:focus,
  .search-form select:focus {
    border-color: #0056b3;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 86, 179, 0.4);
  }

  .search-form .btn,
  .search-form a.btn {
    min-width: 110px;
    padding: 8px 12px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 4px;
    border: none;
    transition: background-color 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 6px;
  }

  .search-form button.btn-primary {
    background-color: #007bff;
    color: white;
  }

  .search-form button.btn-primary:hover {
    background-color: #0056b3;
  }

  .search-form a.btn-secondary {
    background-color: #6c757d;
    color: white;
    text-decoration: none;
    border: none;
  }

  .search-form a.btn-secondary:hover {
    background-color: #5a6268;
  }

  .search-form a.btn-outline-success {
    background-color: transparent;
    color: #28a745;
    border: 2px solid #28a745;
    text-decoration: none;
  }

  .search-form a.btn-outline-success:hover {
    background-color: #28a745;
    color: white;
  }
</style>

<div class="contenedor-inmuebles">
<div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
<form class="search-form" method="GET" aria-label="Formulario de búsqueda de inmuebles">

  <div>
    <label for="search-input">Buscar inmuebles</label>
    <input
      id="search-input"
      type="text"
      name="q"
      value="{{ search_query }}"
      placeholder="Nombre, RFI, Estado o Municipio"
      autocomplete="off"
    >
  </div>

  <div>
    <label for="prioridad">Prioridad</label>
    <select id="prioridad" name="prioridad">
      <option value="" {% if not prioridad %}selected{% endif %}>Todas</option>
      <option value="Alta" {% if prioridad == 'Alta' %}selected{% endif %}>Alta</option>
      <option value="Media" {% if prioridad == 'Media' %}selected{% endif %}>Media</option>
      <option value="Baja" {% if prioridad == 'Baja' %}selected{% endif %}>Baja</option>
    </select>
  </div>

  <div>
    <label for="ur-select">Unidad Responsable</label>
    <select id="ur-select" name="ur">
      <option value="" {% if not ur %}selected{% endif %}>Todas</option>
      <option value="CGEE" {% if ur == 'CGEE' %}selected{% endif %}>CGEE</option>
      <option value="DGB" {% if ur == 'DGB' %}selected{% endif %}>DGB</option>
      <option value="DGBTEPD" {% if ur == 'DGBTEPD' %}selected{% endif %}>DGBTEPD</option>
      <option value="DGCFT" {% if ur == 'DGCFT' %}selected{% endif %}>DGCFT</option>
      <option value="DGETAyCM" {% if ur == 'DGETAyCM' %}selected{% endif %}>DGETAyCM</option>
      <option value="DGETI" {% if ur == 'DGETI' %}selected{% endif %}>DGETI</option>
      <option value="DGRMyS" {% if ur == 'DGRMyS' %}selected{% endif %}>DGRMyS</option>
      <option value="RESEMS" {% if ur == 'RESEMS' %}selected{% endif %}>RESEMS</option>
    </select>
  </div>

  <div>
    <label for="ordenar-por">Ordenar</label>
    <select id="ordenar-por" name="ordenar">
      <option value="" {% if not orden %}selected{% endif %}>Ordenar</option>
      <option value="mas_utilizados" {% if orden == 'mas_utilizados' %}selected{% endif %}>Más Utilizados</option>
      <option value="az" {% if orden == 'az' %}selected{% endif %}>A a Z</option>
      <option value="za" {% if orden == 'za' %}selected{% endif %}>Z a A</option>
      <option value="nuevo" {% if orden == 'nuevo' %}selected{% endif %}>Más nuevo</option>
      <option value="viejo" {% if orden == 'viejo' %}selected{% endif %}>Más viejo</option>
    </select>
  </div>

  <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
    <button class="btn btn-primary" type="submit" aria-label="Buscar inmuebles">Buscar</button>

    <a href="{% url 'Inmuebles' %}" class="btn btn-secondary" aria-label="Limpiar filtros">Limpiar</a>

    <a href="{% url 'export_tasks_to_excelIMP' %}" class="btn btn-outline-success" aria-label="Exportar listado a Excel">
      <i class="fas fa-file-excel"></i> Excel
    </a>
  </div>

</form>
</div>


{% if mensaje %}
  <div style="max-width:1000px;margin:0 auto 20px;color:#0366d6;font-weight:600;">{{ mensaje }}</div>
{% endif %}



{% if inmuebles %}
<div>Total Inmuebles Terminados: {{ total_completed_inmuebles }} --- Total de Inmuebles Completados: {{ total_pending_inmuebles}}</div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>Estado</th>
          <th>RFI</th>
          <th>Entidad Federativa</th>
          <th>Municipio</th>
          <th>UR</th>
          <th>Prioridad</th>
          <th>Asignado a</th>
          <th>Entrega para</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for task in inmuebles %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{% if task.important %}<strong>{{ task.NombreInmueble }}</strong>{% else %}{{ task.NombreInmueble }}{% endif %}</td>
            <td>{{ task.estado|default_if_none:"Baja" }}</td>
            <td>{{ task.rfi|default:"SIN ASIGNAR" }}</td>
            <td>{{ task.entidad_federativa|default:"SIN ASIGNAR" }}</td>
            <td>{{ task.municipio_alcaldia|default:"SIN ASIGNAR" }}</td>
            <td>{{ task.UR|default:"SIN ASIGNAR" }}</td>
            <td>{{ task.prioridad|default:"SIN ASIGNAR" }}</td>
            <td>
              {% if task.assigned_to %}
                {{ task.assigned_to.first_name|default:"" }} {{ task.assigned_to.last_name|default:"" }}
              {% else %}
                SIN ASIGNAR
              {% endif %}
            </td>
            <td>{{ task.deadline|date:"d/m/Y"|default:"SIN ASIGNAR" }}</td>
            <td>
              <a href="{% url 'Detalle_inmueble' task.id %}" aria-label="Ver detalles {{ task.NombreInmueble }}" title="Detalles" style="color:#007bff;margin-right:8px;">
                <i class="bi bi-info-circle-fill"></i>
              </a>
              <a href="{% url 'generate_pdfIMP' task.id %}" target="_blank" aria-label="Generar PDF {{ task.NombreInmueble }}" title="PDF" style="color:#dc3545;">
                <i class="bi bi-file-earmark-pdf"></i>
              </a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <nav aria-label="Navegación de página" class="pagination-container">
    <ul class="pagination">
      {% if inmuebles.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page=1" aria-label="Primera página">&laquo;</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.previous_page_number }}" aria-label="Página anterior">{{ inmuebles.previous_page_number }}</a>
        </li>
      {% endif %}

      <li class="page-item active" aria-current="page">
        <span class="page-link">{{ inmuebles.number }}</span>
      </li>

      {% if inmuebles.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.next_page_number }}" aria-label="Página siguiente">{{ inmuebles.next_page_number }}</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.paginator.num_pages }}" aria-label="Última página">&raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <p style="text-align:center; color:#666; font-size:1.1rem;">No se encontraron inmuebles que coincidan con la búsqueda.</p>
{% endif %}
</div>
{% endblock %}
