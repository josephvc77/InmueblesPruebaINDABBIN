{% extends 'base.html' %}

{% block titulo %}Tareas Pendientes{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Buscador y filtros -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <form class="row g-3 align-items-end" method="GET" aria-label="Formulario de búsqueda de inmuebles">

        <div class="col-md-3">
          <label for="search-input" class="form-label">Buscar</label>
          <input type="text" class="form-control" id="search-input" name="q" 
                 value="{{ search_query }}" placeholder="Nombre, RFI, Estado o Municipio">
        </div>

        <div class="col-md-2">
          <label for="prioridad" class="form-label">Prioridad</label>
          <select id="prioridad" name="prioridad" class="form-select">
            <option value="" {% if not prioridad %}selected{% endif %}>Todas</option>
            <option value="Alta" {% if prioridad == 'Alta' %}selected{% endif %}>Alta</option>
            <option value="Media" {% if prioridad == 'Media' %}selected{% endif %}>Media</option>
            <option value="Baja" {% if prioridad == 'Baja' %}selected{% endif %}>Baja</option>
          </select>
        </div>

        <div class="col-md-3">
          <label for="ur-select" class="form-label">Unidad Responsable</label>
          <select id="ur-select" name="ur" class="form-select">
            <option value="" {% if not ur %}selected{% endif %}>Todas</option>
            <option value="CGEE" {% if ur == 'CGEE' %}selected{% endif %}>CGEE</option>
            <option value="DGB" {% if ur == 'DGB' %}selected{% endif %}>DGB</option>
            <option value="DGBTEPD" {% if ur == 'DGBTEPD' %}selected{% endif %}>DGBTEPD</option>
            <option value="DGCFT" {% if ur == 'DGCFT' %}selected{% endif %}>DGCFT</option>
            <option value="DGETAyCM" {% if ur == 'DGETAyCM' %}selected{% endif %}>DGETAyCM</option>
            <option value="DGETI" {% if ur == 'DGETI' %}selected{% endif %}>DGETI</option>
            <option value="DGRMyS" {% if ur == 'DGRMyS' %}selected{% endif %}>DGRMyS</option>
            <option value="RESEMS" {% if ur == 'RESEMS' %}selected{% endif %}>RESEMS</option>
          </select>
        </div>

        <div class="col-md-2">
          <label for="ordenar-por" class="form-label">Ordenar</label>
          <select id="ordenar-por" name="ordenar" class="form-select">
            <option value="" {% if not orden %}selected{% endif %}>Ordenar</option>
            <option value="mas_utilizados" {% if orden == 'mas_utilizados' %}selected{% endif %}>Más Utilizados</option>
            <option value="az" {% if orden == 'az' %}selected{% endif %}>A a Z</option>
            <option value="za" {% if orden == 'za' %}selected{% endif %}>Z a A</option>
            <option value="nuevo" {% if orden == 'nuevo' %}selected{% endif %}>Más nuevo</option>
            <option value="viejo" {% if orden == 'viejo' %}selected{% endif %}>Más viejo</option>
          </select>
        </div>

<div class="col-md-2 d-flex gap-2" style="flex-wrap: wrap;">
  <button class="btn btn-primary flex-fill" type="submit"><i class="fas fa-search me-1"></i> Buscar</button>
  <a href="{% url 'Inmuebles' %}" class="btn btn-secondary flex-fill"><i class="fas fa-sync-alt me-1"></i> Limpiar</a>
  <a href="{% url 'export_tasks_to_excelIMP' %}" class="btn btn-success flex-fill"><i class="fas fa-file-excel me-1"></i> Excel</a>
</div>



      </form>
    </div>
  </div>
{% if mensaje %}
  <div class="alert alert-info text-center shadow-sm rounded">{{ mensaje }}</div>
{% endif %}

{% if inmuebles %}
  <div class="mb-3 text-muted fw-semibold">
    <i class="bi bi-check-circle-fill text-success"></i> Terminados: {{ total_completed_inmuebles }}
    &nbsp;|&nbsp; 
    <i class="bi bi-hourglass-split text-warning"></i> Pendientes: {{ total_pending_inmuebles }}
  </div>

  <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
    <table class="table table-striped table-hover align-middle shadow-sm border rounded">
      <thead class="table-dark sticky-top">
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>Estado</th>
          <th>RFI</th>
          <th>Entidad</th>
          <th>Municipio</th>
          <th>UR</th>
          <th>Prioridad</th>
          <th>Asignado a</th>
          <th>Entrega para</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody style="font-size: 12px;">
        {% for task in inmuebles %}
        <tr>
          <td class="fw-bold">{{ forloop.counter }}</td>
          <td>
            {% if task.important %}
              <i class="bi bi-star-fill text-warning"></i>
              <strong>{{ task.NombreInmueble }}</strong>
            {% else %}
              {{ task.NombreInmueble }}
            {% endif %}
          </td>
          <td>{{ task.estado|default_if_none:"Baja" }}</td>
          <td>{{ task.rfi|default:" " }}</td>
          <td>{{ task.entidad_federativa|default:" " }}</td>
          <td>{{ task.municipio_alcaldia|default:" " }}</td>
          <td>{{ task.UR|default:" " }}</td>
          <td>
            {% if task.prioridad %}
              <span class="badge d-inline-flex align-items-center 
                {% if task.prioridad == 'Alta' %} bg-danger 
                {% elif task.prioridad == 'Media' %} bg-warning text-dark 
                {% else %} bg-success {% endif %}">
                <i class="bi {% if task.prioridad == 'Alta' %}bi-exclamation-triangle-fill{% elif task.prioridad == 'Media' %}bi-arrow-up-circle-fill{% else %}bi-check-circle-fill{% endif %} me-1"></i>
                {{ task.prioridad }}
              </span>
            {% else %}
              <span class="text-muted">Por Asignar</span>
            {% endif %}
          </td>
          <td>
            {% if task.assigned_to %}
              {{ task.assigned_to.first_name }} {{ task.assigned_to.last_name }}
            {% else %}
              <span class="text-muted">Por Asignar</span>
            {% endif %}
          </td>
          <td>{{ task.deadline|date:"d/m/Y"|default:" Pendiente" }}</td>
          <td class="text-center">
            <div class="btn-group" role="group">
              <a href="{% url 'Detalle_inmueble' task.id %}" class="btn btn-sm btn-outline-primary" title="Detalles">
                <i class="bi bi-info-circle-fill"></i>
              </a>
              <a href="{% url 'generate_pdfIMP' task.id %}" target="_blank" class="btn btn-sm btn-outline-danger" title="PDF">
                <i class="bi bi-file-earmark-pdf-fill"></i>
              </a>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginación -->
  <nav aria-label="Navegación de página" class="mt-4">
    <ul class="pagination justify-content-center pagination-sm">
      {% if inmuebles.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page=1">&laquo; Primero</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.previous_page_number }}">Anterior</a>
        </li>
      {% endif %}

      <li class="page-item active">
        <span class="page-link">{{ inmuebles.number }}</span>
      </li>

      {% if inmuebles.has_next %}
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.next_page_number }}">Siguiente</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ inmuebles.paginator.num_pages }}">Última &raquo;</a>
        </li>
      {% endif %}
    </ul>
  </nav>

{% else %}
  <div class="alert alert-warning text-center shadow-sm rounded">
    <i class="bi bi-exclamation-circle"></i> No se encontraron inmuebles que coincidan con la búsqueda.
  </div>
{% endif %}
</div>
{% endblock %}
