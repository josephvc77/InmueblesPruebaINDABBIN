{% extends 'base.html' %}

{% block titulo %}Detalle de Tarea{% endblock %}

{% block content %}
<div class="container my-4">

  <!-- Información de la tarea -->
  <div class="card mb-3 shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0">{{ tarea.NombreInmueble }}</h6>
      <a href="{% url 'registro_llamada' tarea.id %}" class="btn btn-sm btn-success">
        <i class="bi bi-plus-circle"></i> Nueva llamada
      </a>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-3"><strong>RFI:</strong> {{ tarea.rfi|default:"SIN ASIGNAR" }}</div>
        <div class="col-md-3"><strong>Estado:</strong> {{ tarea.estado|default:"SIN ASIGNAR" }}</div>
        <div class="col-md-3"><strong>Prioridad:</strong>
          {% if tarea.prioridad %}
            <span class="badge
              {% if tarea.prioridad == 'Alta' %} bg-danger
              {% elif tarea.prioridad == 'Media' %} bg-warning text-dark
              {% else %} bg-success {% endif %}">
              {{ tarea.prioridad }}
            </span>
          {% else %}
            <span class="text-muted">SIN ASIGNAR</span>
          {% endif %}
        </div>
        <div class="col-md-3"><strong>UR:</strong> {{ tarea.ur|default:"SIN ASIGNAR" }}</div>
      </div>
      <div class="row mt-2">
        <div class="col-md-3"><strong>Asignado a:</strong>
          {% if tarea.assigned_task %}
            {{ tarea.assigned_task.first_name }} {{ tarea.assigned_task.last_name }}
          {% else %}
            <span class="text-muted">No asignada</span>
          {% endif %}
        </div>
        <div class="col-md-3"><strong>Deadline:</strong> 
          {% if tarea.deadline %}{{ tarea.deadline|date:"d/m/Y H:i" }}{% else %}<span class="text-muted">No definida</span>{% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de registros de llamadas -->
  {% if registros %}
    <div class="table-responsive shadow-sm">
      <table class="table table-striped table-hover align-middle text-center">
        <thead class="table-dark sticky-top">
          <tr>
            <th>#</th>
            <th>Número Llamada</th>
            <th>Fecha</th>
            <th>Hora</th>
            <th>Acuerdos/Compromisos</th>
            <th>Fecha Comprometida</th>
            <th>Observaciones</th>
            <th>Finalización</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody style="font-size: 13px;">
          {% for reg in registros %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ reg.NumLlamada|default:"-" }}</td>
              <td>{{ reg.fecha_llamada|default:"-" }}</td>
              <td>{{ reg.hora_llamada|default:"-" }}</td>
              <td>{{ reg.acuerdos_compromisos|default:"-" }}</td>
              <td>{{ reg.fecha_comprometida|default:"-" }}</td>
              <td>{{ reg.observaciones_generales|default:"-" }}</td>
              <td>{{ reg.finalizacion|default:"-" }}</td>
              <td>
                <!-- Botón para abrir modal -->
                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detalleLlamadaModal{{ reg.id }}">
                  Ver Detalles
                </button>
              </td>
            </tr>

            <!-- Modal de detalles de la llamada -->
            <div class="modal fade" id="detalleLlamadaModal{{ reg.id }}" tabindex="-1" aria-labelledby="detalleLlamadaModalLabel{{ reg.id }}" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-scrollable">
                <div class="modal-content">
                  <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title" id="detalleLlamadaModalLabel{{ reg.id }}">Detalle de la llamada #{{ forloop.counter }}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row mb-2">
                      <div class="col-md-3"><strong>Número Llamada:</strong> {{ reg.NumLlamada|default:"-" }}</div>
                      <div class="col-md-3"><strong>Fecha:</strong> {{ reg.fecha_llamada|date:"d/m/Y" }}</div>
                      <div class="col-md-3"><strong>Hora:</strong> {{ reg.hora_llamada|default:"-" }}</div>
                      <div class="col-md-3"><strong>Finalización:</strong> {{ reg.finalizacion|date:"d/m/Y"|default:"-" }}</div>
                    </div>
                    <div class="row mb-2">
                      <div class="col-md-6"><strong>Acuerdos/Compromisos:</strong> {{ reg.acuerdos_compromisos|default:"-" }}</div>
                      <div class="col-md-6"><strong>Observaciones:</strong> {{ reg.observaciones_generales|default:"-" }}</div>
                    </div>
                    <div class="row mb-2">
                      <div class="col-md-3"><strong>Fecha Comprometida:</strong> {{ reg.fecha_comprometida|default:"-" }}</div>
                      <div class="col-md-3"><strong>Fecha Respuesta Email:</strong> {{ reg.fecha_respuesta_email|default:"-" }}</div>
                      <div class="col-md-3"><strong>Fecha Revisión Correcciones:</strong> {{ reg.fecha_revision_correcciones|default:"-" }}</div>
                      <div class="col-md-3"><strong>Fecha Envío Correcciones:</strong> {{ reg.fecha_envio_correccion|default:"-" }}</div>
                    </div>
                    <div class="row">
                      <div class="col-md-6"><strong>Fecha Aprobación Fichas Corregidas:</strong> {{ reg.fecha_aprobacion_fichas_corregidas|default:"-" }}</div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="alert alert-warning text-center shadow-sm rounded">
      <i class="bi bi-exclamation-circle"></i> No se han registrado llamadas aún.
    </div>
  {% endif %}

  <!-- Botón para volver al listado de tareas -->
  <div class="mt-3">
    <a href="{% url 'tareas_list' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Volver al listado
    </a>
  </div>

</div>
{% endblock %}
