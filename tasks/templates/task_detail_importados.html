{% extends 'base.html' %}
{% block titulo %}Detalles {{ task.NombreInmueble }}{% endblock %}
<title>{{ task.NombreInmueble }} - Detalles</title>

{% block content %}
<div class="contenedor-detalle">
  <div class="task-detail-container">

    <!-- Título y errores -->
    <h2 class="text-center">{{ task.NombreInmueble }}</h2>
    {{ error }}
    {% if errores %}
  <div class="alert alert-danger">
    <ul>
      {% for nombre, err in errores.items %}
        <li><strong>{{ nombre }}:</strong> {{ err|safe }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

    <!-- Formulario principal -->
    <form method="post" action="{% url 'Detalle_inmueble' task.id %}" 
          enctype="multipart/form-data" class="task-form" id="form_detail">
      {% csrf_token %}

      <!-- Pestañas -->
      <div class="task-form-container">
        <div id="mobile-menu-button" class="mobile-menu-button">&#9776;</div>
        <div class="tabs">
          <div class="tab" data-tab="tab-mensajes">
            <span class="tab-title">Pendientes</span>
            {% if task.mensajes.all|length > 0 %}
            <span class="badge rounded-pill bg-danger ms-2">
              {{ task.mensajes.all|length }}
            </span>
            {% endif %}
          </div>
          <div class="tab active" data-tab="tab-encabezado">Encabezado</div>
          <div class="tab" data-tab="tab-descripcion">Datos Generales</div>
          <div class="tab" data-tab="tab-ubicacion">Ubicación</div>
          <div class="tab" data-tab="tab-caracteristicas">Características</div>
          <div class="tab" data-tab="tab-tituloProp">TÍTULO DE PROPIEDAD</div>
          <div class="tab" data-tab="tab-uso">Uso</div>
          <div class="tab" data-tab="tab-aprovechamiento">Aprovechamiento</div>
          <div class="tab" data-tab="tab-valor">Valor</div>
          <div class="tab" data-tab="tab-tramites-ocupaciones">Trámites y Ocupaciones</div>
          <div class="tab" data-tab="tab-observaciones">Observaciones</div>
        </div>
      </div>

      <!-- Contenido de las pestañas -->
      <div class="tab-content">
        <div class="tab-content-item" data-tab="tab-mensajes">Pendientes</div>
        <div class="tab-content-item" data-tab="tab-encabezado">Encabezado</div>
        <div class="tab-content-item" data-tab="tab-descripcion">Datos Generales</div>
        <div class="tab-content-item" data-tab="tab-ubicacion">Ubicación</div>
        <div class="tab-content-item" data-tab="tab-caracteristicas">Características</div>
        <div class="tab-content-item" data-tab="tab-tituloProp">TÍTULO DE PROPIEDAD</div>
        <div class="tab-content-item" data-tab="tab-uso">Uso</div>
        <div class="tab-content-item" data-tab="tab-aprovechamiento">Aprovechamiento</div>
        <div class="tab-content-item" data-tab="tab-valor">Valor</div>
        <div class="tab-content-item" data-tab="tab-tramites-ocupaciones">Trámites y Ocupaciones</div>
        <div class="tab-content-item" data-tab="tab-observaciones">Observaciones</div>
      </div>

      <!-- RFI y RFI provisional -->
      <div class="form-group form-check-inline">
        {% if inmueble.rfi %}
          <label for="{{ inmueble.rfi.id_for_label }}">RFI:</label>
          <input class="form-control form-control-sm text-center" type="text" 
                 id="{{ inmueble.rfi.id }}" name="{{ inmueble.rfi.name }}" 
                 value="{{ inmueble.rfi.value }}" readonly>
        {% else %}
          <label for="sin-rfi">RFI:</label>
          <input class="form-control form-control-sm text-center" type="text" 
                 id="sin-rfi" value="SIN RFI ASIGNADO" readonly>
        {% endif %}
      </div>

      <div class="form-group form-check-inline">
        <label for="{{ inmueble.rfiProv.id_for_label }}">RFI Provisional:</label>
        {{ inmueble.rfiProv }}
      </div>

      <!-- Inclusión de secciones importadas -->
      {% include 'extends_importados/encabezado.html' %}
      {% include 'extends_importados/datos_generales.html' %}
      {% include 'extends_importados/ubicacion.html' %}
      {% include 'extends_importados/caracteristicas.html' %}
      {% include 'extends_importados/tituloProp.html' %}
      {% include 'extends_importados/uso.html' %}
      {% include 'extends_importados/aprovechamiento.html' %}
      {% include 'extends_importados/valor.html' %}
      {% include 'extends_importados/tramites_ocupaciones.html' %}
      {% include 'extends_importados/observaciones.html' %}
      {% include 'extends_importados/enviar_mensaje.html' %}
      

    </form>
  </div> <!-- task-detail-container -->
</div> <!-- contenedor-detalle -->
    <!-- Botones principales -->
    <div class="buttons mt-3">
      <button type="button" class="btn btn-outline-primary actualizar">Guardar Cambios</button>
      <a href="{% url 'generate_pdfIMP' task.id %}" class="btn btn-primary" target="_blank">
        <i class="fas fa-file-pdf"></i> Generar PDF
      </a>
      <form id="complete-form" action="{% url 'complete_task_importados' task.id %}" method="POST" style="margin:0;">
        {% csrf_token %}
        <button type="button" class="btn btn-success" onclick="showCompleteConfirmation()">Terminar</button>
      </form>
      <form id="delete-form" action="{% url 'bajas_importados' task.id %}" method="POST" style="margin:0;">
        {% csrf_token %}
        <button type="button" class="btn btn-warning" id="darDeBajaButton">Dar de baja</button>
      </form>
    </div>
</div>
</div>

{% include 'extends_importados/scripts.html' %}

{% load static%}

<style>
  /* Contenedor general */
  .contenedor-detalle {
    max-width: 100vw;
    margin: 20px auto;
    background: #f8f9fa;
  }

  /* Tabs */
  .tabs {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-bottom: 20px;
  }

  .tab {
    flex: 1;
    text-align: center;
    padding: 10px 12px;
    cursor: pointer;
    background: #e9ecef;
    border-radius: 8px 8px 0 0;
    transition: all 0.3s ease;
    font-weight: 500;
    position: relative;
  }

  .tab.active {
    background: #0d6efd;
    color: white;
    font-weight: 600;
  }

  .tab .badge {
    position: absolute;
    top: -10px;
    right: 0px;
    font-size: 0.7rem;
  }

  /* Contenido de pestañas */
  .tab-content-item {
    display: none;
    padding: 20px;
    background: white;
    border-radius: 0 12px 12px 12px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
  }

  .tab-content-item.active {
    display: block;
  }

  /* Botones agrupados */
  .buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 20px;
  }

  .buttons .btn {
    min-width: 140px;
    flex: 1;
  }

  @media (max-width: 768px) {
    .tabs {
      flex-direction: column;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const btnGuardar = document.querySelector(".btn.actualizar");
    btnGuardar.addEventListener("click", function () {
      Swal.fire({
        title: '¿Estás seguro de guardar?',
        html: `
        Verifica antes de guardar los formularios individualmente
        <div class="accordion accordion-flush mt-2" id="accordionFlushExample">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                No sabes cuales son los formularios de guardado individual?
              </button>
            </h2>
          </div>
        </div>
      `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Sí, guardar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          // Envía el formulario
          document.getElementById('form_detail').submit();
        } else {
          Swal.fire('No se han realizado cambios', '', 'info');
        }
      });
    });
  });
</script>


<script>
  document.getElementById('mobile-menu-button').addEventListener('click', function () {
    document.querySelector('.tabs').classList.toggle('active');
  });

  document.querySelectorAll('.tabs .tab').forEach(function (tab) {
    tab.addEventListener('click', function () {
      document.querySelectorAll('.tab-content-item').forEach(function (contentItem) {
        contentItem.classList.remove('active');
      });
      var tabId = tab.getAttribute('data-tab');
      document.querySelector('.tab-content-item[data-tab="' + tabId + '"]').classList.add('active');
    });
  });


  const notificationsCount = `{{ user.mensajes.unread.count }}`;
  const notificationsBadge = document.getElementById('notifications-count');
  notificationsBadge.textContent = notificationsCount;
  if (notificationsCount > 0) {
    const notificationsButton = document.querySelector('.notifications');
    notificationsButton.classList.remove('d-none');
  } else {
    const notificationsButton = document.querySelector('.notifications');
    notificationsButton.classList.add('d-none');
  }
  document.addEventListener('DOMContentLoaded', function () {
    function confirmAndDelete(button, message) {
      button.addEventListener('click', function (event) {
        event.preventDefault();
        const url = this.dataset.url;
        Swal.fire({
          title: '¿Estás seguro?',
          text: message,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: 'Sí, eliminar',
          cancelButtonText: 'Cancelar'
        }).then((result) => {
          if (result.isConfirmed) {
            fetch(url, {
              method: 'DELETE',
              headers: {
                'X-CSRFToken': '{{ csrf_token }}',
              }
            })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  const row = button.closest('tr');
                  row.remove();
                  Swal.fire('Eliminado', 'El elemento ha sido eliminado correctamente', 'success');
                } else {
                  console.error('Error:', data.message);
                  Swal.fire('Error', 'Hubo un problema al intentar eliminar el elemento', 'error');
                }
              })
              .catch(error => {
                console.error('Error:', error);
                Swal.fire('Error', 'Hubo un problema al intentar eliminar el elemento', 'error');
              });
          }
        });
      });
    }

    const deleteExpedienteCedocButtons = document.querySelectorAll('.delete-expediente-cedoc-btn');
    const deleteFolioRealButtons = document.querySelectorAll('.delete-folio-real-btn');
    const deleteNumeroPlanoButtons = document.querySelectorAll('.delete-numero-plano-btn');
    const deleteEdificioVerdeButtons = document.querySelectorAll('.delete-edificio-verde-btn');
    const deleteTramiteDisposicion = document.querySelectorAll('.delete-tramite-btn');
    const deleteColindancia = document.querySelectorAll('.delete-colindancia-btn');

    deleteExpedienteCedocButtons.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar este expediente cedoc?');
    });

    deleteFolioRealButtons.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar este Folio?');
    });

    deleteNumeroPlanoButtons.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar este No. Plano?');
    });
    deleteEdificioVerdeButtons.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar este Edificio verde?');
    });
    deleteTramiteDisposicion.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar este Tramite?');
    });
    deleteColindancia.forEach(button => {
      confirmAndDelete(button, '¿Estás seguro de que deseas eliminar esta Colindancia?');
    });
  });
</script>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
  function showCompleteConfirmation() {
    Swal.fire({
      title: '¿Estás seguro?',
      text: 'Una vez completada, la tarea ya no podrá ser modificada.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#28a745',
      cancelButtonColor: '#dc3545',
      confirmButtonText: 'Sí, Completar',
      cancelButtonText: 'Cancelar',
    }).then((result) => {
      if (result.isConfirmed) {
        // Si el usuario confirma, enviar el formulario de completar la tarea
        document.getElementById('complete-form').submit();
      }
    });
  }

  document.getElementById('darDeBajaButton').addEventListener('click', function () {
    showBajaConfirmation();
  });
  function showBajaConfirmation() {
    Swal.fire({
      title: '¿Dar de baja esta tarea?',
      text: 'Una vez que una tarea se da de baja, no se puede modificar.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#dc3545',
      cancelButtonColor: '#6c757d',
      confirmButtonText: 'Sí, Dar de baja',
      cancelButtonText: 'Cancelar',
    }).then((result) => {
      if (result.isConfirmed) {
        // Si el usuario confirma, enviar el formulario de dar de baja
        document.getElementById('delete-form').submit();
      }
    });
  }
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    const localStorageKey = 'activeTab';

    // Función para activar una pestaña
    function activateTab(tab) {
      const targetTab = tab.dataset.tab;
      tabs.forEach((tab) => tab.classList.remove('active'));
      tabContents.forEach((content) => content.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(targetTab).classList.add('active');
      localStorage.setItem(localStorageKey, targetTab);
    }
    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        activateTab(tab);
      });
    });
    const savedActiveTab = localStorage.getItem(localStorageKey);
    if (savedActiveTab) {
      const tabToActivate = document.querySelector(`[data-tab="${savedActiveTab}"]`);
      if (tabToActivate) {
        activateTab(tabToActivate);
      }
    }
  });
</script>

<script>
  function showEdificacionForm() {
    document.getElementById('edificacion-form').style.display = 'block';
    document.getElementById('terreno-form').style.display = 'none';
  }
  function showTerrenoForm() {
    document.getElementById('edificacion-form').style.display = 'none';
    document.getElementById('terreno-form').style.display = 'block';
  }
</script>
<script>
  $(document).ready(function () {
    // Ocultar todos los formularios al principio
    $('#form-edificacion').hide();
    $('#form-terreno').hide();

    // Mostrar u ocultar formularios según la opción seleccionada
    $('#tipo_opcion').on('change', function () {
      var selectedOption = $(this).val();

      if (selectedOption === 'sin_informacion') {
        $('#form-edificacion').hide();
        $('#form-terreno').hide();
      } else if (selectedOption === 'edificacion' || selectedOption === 'mixto') {
        $('#form-edificacion').show();
        $('#form-terreno').hide();
      } else if (selectedOption === 'terreno') {
        $('#form-edificacion').hide();
        $('#form-terreno').show();
      }
    });
  });
</script>

{% if message %}
<script>
  Swal.fire({
    title: "{{ message.title }}",
    text: "{{ message.text }}",
    icon: "{{ message.icon }}",
    timer: 3000,  // Duración de la alerta en milisegundos (opcional)
    showConfirmButton: false, // Oculta el botón de confirmación
  });
</script>
{% endif %}



{% endblock %}