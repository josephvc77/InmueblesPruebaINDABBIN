{% extends 'base.html' %}

{% block titulo %} Tareas Pendientes {% endblock %}

{% block content %}
<div class="container-llamadas my-4 animated fadeIn">
  <div class="card shadow">
    <div style="background-color: #691c32;" class="card-header text-white d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Filtrar Tareas</h5>
      <i class="fas fa-tasks"></i>
    </div>
    <div class="card-body">
      <form method="GET">
        <div style="display: flex;">

          <!-- Buscador -->
          <div class="col-md-6 mb-3">
            <label for="busqueda"><strong>Búsqueda</strong></label>
            <div class="input-group">
              <input type="text" name="q" id="busqueda" class="form-control"
                placeholder="Nombre, RFI, Entidad Federativa o Municipio" value="{{ search_query }}">
            </div>
          </div>

          <!-- Prioridad -->
          <div class="col-md-2 mb-3">
            <label for="prioridad"><strong>Prioridad</strong></label>
            <select id="prioridad" name="prioridad" class="form-control">
              <option value="" {% if not prioridad %}selected{% endif %}>Todas</option>
              <option value="Alta" {% if prioridad == 'Alta' %}selected{% endif %}>Alta</option>
              <option value="Media" {% if prioridad == 'Media' %}selected{% endif %}>Media</option>
              <option value="Baja" {% if prioridad == 'Baja' %}selected{% endif %}>Baja</option>
            </select>
          </div>

          <!-- UR -->
          <div class="col-md-2 mb-3">
            <label for="ur-select"><strong>Unidad Responsable</strong></label>
            <select id="ur-select" name="ur" class="form-control">
              <option value="">UR</option>
              {% for opcion in ur_opciones %}
              <option value="{{ opcion }}" {% if ur == opcion %}selected{% endif %}>{{ opcion }}</option>
              {% endfor %}
            </select>
          </div>

          <!-- Ordenar -->
          <div class="col-md-2 mb-3">
            <label for="ordenar-por"><strong>Ordenar por</strong></label>
            <select id="ordenar-por" name="ordenar" class="form-control">
              <option value="">Ordenar</option>
              <option value="az" {% if orden == "az" %}selected{% endif %}>A a Z</option>
              <option value="za" {% if orden == "za" %}selected{% endif %}>Z a A</option>
              <option value="nuevo" {% if orden == "nuevo" %}selected{% endif %}>Más nuevo</option>
              <option value="viejo" {% if orden == "viejo" %}selected{% endif %}>Más viejo</option>
            </select>
          </div>
        </div>

        <!-- Botones -->
        <div class="form-row mt-2">
          <div class="col-md-12 text-right">
            <button class="btn btn-outline-primary" type="submit">
              <i class="fas fa-search"></i> Buscar
            </button>
            <a href="{% url 'export_Llamadas_to_excelIMP' %}" class="btn btn-outline-success btn-sm ml-2">
              <i class="fas fa-file-excel"></i> Exportar Excel
            </a>
          </div>
        </div>

        {% if mensaje %}
        <div class="alert alert-info mt-3">{{ mensaje }}</div>
        {% endif %}
      </form>
    </div>
  </div>
</div>


{% if llamadas %}
<div class="container mt-4">
  <div class="table-responsive">
    <table class="table table-bordered table-hover text-center">
      <thead class="thead-dark">
        <tr>
          <th>Nombre Inmueble</th>
          <th>RFI</th>
          <th>EDO</th>
          <th>UR</th>
          <th>Estatus Llamada</th>
          <th>Prioridad</th>
          <th>Tarea Asignada</th>
          <th>Entrega</th>
          <th>Retraso/Estado</th>
          <th>Creado</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for ficha in llamadas %}
        <tr>
          <td>
            {{ ficha.NombreInmueble }}
          </td>
          <td>{{ ficha.rfi }}</td>
          <td>{{ ficha.edo }}</td>
          <td>{{ ficha.ur }}</td>
          <td>{{ ficha.estatus_llamada }}</td>
          <td
            class="{% if ficha.prioridad == 'Alta' %} alta-priority {% elif ficha.prioridad == 'Media' %} media-priority {% else %} baja-priority {% endif %}">
            {{ ficha.prioridad }}
          </td>
          <td>
            {% if ficha.assigned_task %}
            {{ ficha.assigned_task.first_name }} {{ ficha.assigned_task.last_name }}
            {% else %}
            No asignada
            {% endif %}
          </td>
          <td>
            {% if ficha.deadline %}
            {{ ficha.deadline }}
            {% else %}
            No definida
            {% endif %}
          </td>
          <td>
            {% if ficha.completed %}
            <span class="text-success">Completada</span>
            {% elif ficha.days_delayed > 0 %}
            <span class="text-danger">Retrasada por: {{ ficha.days_delayed }} días {{ ficha.hours_delayed }} hrs</span>
            {% elif ficha.hours_delayed > 0 %}
            <span class="text-danger">Retrasada por: {{ ficha.hours_delayed }} hrs</span>
            {% elif ficha.days_remaining > 0 or ficha.hours_remaining > 0 %}
            Tiempo restante: {{ ficha.days_remaining }} días {{ ficha.hours_remaining }} hrs
            {% else %}
            Sin información
            {% endif %}
          </td>
          <td>{{ ficha.creado }}</td>
          <td>
            <a href="{% url 'task_detail_llamadas' ficha.id %}" class="text-primary mr-2" title="Ver detalles">
              <i class="bi bi-info-circle-fill"></i>
            </a>
            <a href="" class="text-danger" title="Generar PDF">
              <i class="bi bi-file-earmark-pdf"></i>
            </a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Paginador -->
  <nav class="mt-4">
    <ul class="pagination justify-content-center">
      {% if llamadas.has_previous %}
      <li class="page-item">
        <a class="page-link"
          href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page=1">&laquo;</a>
      </li>
      <li class="page-item">
        <a class="page-link"
          href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ llamadas.previous_page_number }}">{{
          llamadas.previous_page_number }}</a>
      </li>
      {% endif %}

      <li class="page-item active"><span class="page-link">{{ llamadas.number }}</span></li>

      {% if llamadas.has_next %}
      <li class="page-item">
        <a class="page-link"
          href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ llamadas.next_page_number }}">{{
          llamadas.next_page_number }}</a>
      </li>
      <li class="page-item">
        <a class="page-link"
          href="?q={{ search_query }}&prioridad={{ prioridad }}&ur={{ ur }}&ordenar={{ orden }}&page={{ llamadas.paginator.num_pages }}">&raquo;</a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% else %}
<div class="container text-center my-5">
  <p class="text-muted">No se encontraron tareas que coincidan con la búsqueda.</p>
</div>
{% endif %}

<style>
 .container-llamadas {
  display: flex;
  flex-direction: column;
  width: 100%;
  margin: 20px auto;
  max-width: 1400px;
}

.alta-priority {
  background-color: #f8d7da;
  color: #721c24;
  font-weight: bold;
}

.media-priority {
  background-color: #fff3cd;
  color: #856404;
}

.baja-priority {
  background-color: #d4edda;
  color: #155724;
}


</style>

<script>
  document.getElementById("prioridad").addEventListener("change", function () {
    this.form.submit();
  });
  document.getElementById("ur-select").addEventListener("change", function () {
    this.form.submit();
  });
  document.getElementById("ordenar-por").addEventListener("change", function () {
    this.form.submit();
  });
</script>

{% endblock %}